<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fabrick Lightbox - Test</title>

  <style>
    /* Reset base */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    /* Layout pagina */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    /* Card centrale */
    .container {
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 600px;
      width: 100%;
      padding: 40px;
      animation: slideUp 0.5s ease-out;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .header { text-align: center; margin-bottom: 30px; }

    .logo {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-size: 28px;
    }

    h1 { color: #2d3748; font-size: 28px; margin-bottom: 10px; }
    .subtitle { color: #718096; font-size: 14px; }

    .info-label { color: #718096; font-size: 14px; }
    .info-value { color: #2d3748; font-weight: 600; font-size: 14px; }

    .form-group { margin-bottom: 20px; }

    label {
      display: block;
      color: #4a5568;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .field-hint {
      display: block;
      color: #a0aec0;
      font-size: 12px;
      margin-top: 5px;
      font-style: italic;
    }

    input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: #fff;
      font-family: 'Courier New', monospace;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    /* Bottone pagamento */
    .pay-button {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      margin-top: 10px;
    }

    .pay-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }
    .pay-button:active:not(:disabled) { transform: translateY(0); }
    .pay-button:disabled { opacity: 0.6; cursor: not-allowed; }

    /* Spinner */
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Box messaggi */
    .status-message {
      margin-top: 20px;
      padding: 16px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .status-message.success {
      background: #c6f6d5;
      color: #22543d;
      border: 2px solid #9ae6b4;
    }
    .status-message.error {
      background: #fed7d7;
      color: #742a2a;
      border: 2px solid #fc8181;
    } 
    .status-message.pending {
      background: #fef3c7;
      color: #78350f;
      border: 2px solid #fbbf24;
    }
    .status-message.info {
      background: #bee3f8;
      color: #2c5282;
      border: 2px solid #90cdf4;
    }
    .status-message.warning {
      background: #fef3c7;
      color: #78350f;
      border: 2px solid #fbbf24;
    }

    .note {
      background: #e0e7ff;
      border-left: 4px solid #667eea;
      padding: 20px;
      margin-top: 20px;
      border-radius: 4px;
      font-size: 13px;
      color: #3730a3;
    }
    .note strong {
      display: block;
      margin-bottom: 10px;
      color: #1e1b4b;
      font-size: 14px;
    }
    .note ol { margin-left: 20px; margin-top: 10px; }
    .note li { margin-bottom: 8px; line-height: 1.6; }
    .note code {
      background: #c7d2fe;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }

    .api-example {
      background: #1e293b;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      color: #e2e8f0;
      font-size: 13px;
    }
    .api-example strong {
      display: block;
      margin-bottom: 12px;
      color: #fbbf24;
    }
    .api-example pre { margin: 0; overflow-x: auto; }
    .api-example code {
      color: #a5f3fc;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.6;
    }

    .security-badge {
      text-align: center;
      margin-top: 20px;
      padding: 15px;
      background: #f7fafc;
      border-radius: 8px;
      font-size: 12px;
      color: #718096;
    }
    .security-badge svg {
      width: 16px;
      height: 16px;
      vertical-align: middle;
      margin-right: 5px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="logo">ðŸ’³</div>
      <h1>Fabrick Payment</h1>
      <p class="subtitle">Lightbox</p>
    </div>

    <form id="paymentForm" novalidate>
      <div class="form-group">
        <label for="shopLogin">Shop Login</label>
        <input
          type="text"
          id="shopLogin"
          placeholder="GESPAY00001"
          autocomplete="off"
          required
        />
        <small class="field-hint">Codice esercente</small>
      </div>

      <div class="form-group">
        <label for="paymentID">Payment ID</label>
        <input
          type="text"
          id="paymentID"
          placeholder="1360119538182"
          autocomplete="off"
          required
        />
        <small class="field-hint">ID transazione generato dal server</small>
      </div>

      <div class="form-group">
        <label for="paymentToken">Payment Token</label>
        <input
          type="text"
          id="paymentToken"
          placeholder="8a901523-67a5-4aca-bbd2-c7c412934289"
          autocomplete="off"
          required
        />
        <small class="field-hint">Token generato dal server</small>
      </div>

      <button type="submit" class="pay-button" id="payButton">
        <span id="buttonText">Apri Lightbox</span>
      </button>
    </form>

    <div id="statusMessage" class="status-message"></div>

    <div class="note">
      <strong>ðŸ“Œ Istruzioni</strong>
      <ol>
        <li>Effettua la chiamata <code>POST /payment/create</code> dal tuo server</li>
        <li>Ricevi <code>paymentID</code> e <code>paymentToken</code> nella risposta</li>
        <li>Inserisci i dati nei campi sopra</li>
        <li>Clicca su "Apri Lightbox"</li>
      </ol>
    </div>

    <div class="api-example">
      <strong>ðŸ”§ Esempio Request Body Server:</strong>
      <pre><code>{
  "shopLogin": "GESPAY00001",
  "amount": 10.00,
  "currency": "EUR",
  "shopTransactionID": "FBK_OrderID_001"
}</code></pre>
    </div>

    <div class="security-badge">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
      </svg>
      Pagamento sicuro con 3D Secure 2.0
       </div>
    <div class="header">
        <p class="subtitle">Powered by M2NDLAB</p>
      </div>
    </div>
 
  

  <script src="https://sandbox.gestpay.net/pagam/javascript/axerve.js"></script>

  <script>
    // =====================================================
    // CONFIG DEBUG
    // =====================================================
    const DEBUG = true;
    const LOG_PREFIX = '[AXERVE-LB]';

    function log(...args)   { if (DEBUG) console.log(LOG_PREFIX, ...args); }
    function warn(...args)  { if (DEBUG) console.warn(LOG_PREFIX, ...args); }
    function error(...args) { console.error(LOG_PREFIX, ...args); }

    // =====================================================
    // DOM
    // =====================================================
    const form = document.getElementById('paymentForm');
    const payButton = document.getElementById('payButton');
    const buttonText = document.getElementById('buttonText');
    const statusMessage = document.getElementById('statusMessage');

    let lightboxOpen = false;
    let callbackTimeoutId = null;
    const CALLBACK_TIMEOUT_MS = 60000;

    // =====================================================
    // UI helpers
    // =====================================================
    function showMessage(message, type) {
      statusMessage.textContent = message;
      statusMessage.className = `status-message ${type}`;
      statusMessage.style.display = 'block';

      const timeout = (type === 'error' || type === 'warning') ? 8000 : 5000;
      setTimeout(() => { statusMessage.style.display = 'none'; }, timeout);
    }

    function setLoading(isLoading) {
      if (isLoading) {
        payButton.disabled = true;
        buttonText.innerHTML = '<span class="spinner"></span>Apertura in corso...';
      } else {
        payButton.disabled = false;
        buttonText.textContent = 'Apri Lightbox';
      }
    }

    // =====================================================
    // Validation
    // =====================================================
    function validateInputs(shopLogin, paymentID, paymentToken) {
      const errors = [];

      if (!shopLogin || shopLogin.trim().length === 0) errors.push('Shop Login Ã¨ obbligatorio');
      if (!paymentID || paymentID.trim().length === 0) errors.push('Payment ID Ã¨ obbligatorio');
      if (!paymentToken || paymentToken.trim().length === 0) errors.push('Payment Token Ã¨ obbligatorio');

      const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
      if (paymentToken && !uuidRegex.test(paymentToken)) {
        errors.push('Payment Token non sembra un UUID valido');
      }

      return errors;
    }

    // =====================================================
    // CALLBACK - La Lightbox chiude automaticamente
    // =====================================================
    function onAxerveLightboxResult(response) {
      if (callbackTimeoutId) {
        clearTimeout(callbackTimeoutId);
        callbackTimeoutId = null;
      }

      lightboxOpen = false;

      log('âœ… Callback ricevuta:', response);
      log('ðŸ“¦ Response completo:', JSON.stringify(response, null, 2));
      log('ðŸ” response.responseURL:', response.responseURL);
      log('ðŸ” response.status:', response.status);
      log('ðŸ” response.paymentId:', response.paymentId);
      log('â„¹ï¸ La Lightbox si chiude automaticamente');

      handleLightboxCallback(response);

      return false;
    }

    // =====================================================
    // PARSER + UI
    // =====================================================
    function handleLightboxCallback(responseOrEvent) {
      const isMessageEvent =
        responseOrEvent &&
        typeof responseOrEvent === 'object' &&
        'data' in responseOrEvent &&
        'origin' in responseOrEvent;

      const response = isMessageEvent ? responseOrEvent.data : responseOrEvent;

      log('ðŸ“© handleLightboxCallback() called', { isMessageEvent });
      if (isMessageEvent) log('   origin:', responseOrEvent.origin);
      log('   payload:', response);
      
      log('reponse :', JSON.stringify(response, null, 2));

      if (!response) {
        warn('âš  Callback senza payload (response nullo/undefined)');
        showMessage('âš  Callback ricevuta ma payload vuoto', 'warning');
        return;
      }

      const status = response.status;
      const paymentId = response.paymentId || response.paymentID;
      const responseURL = response.responseURL;
      const errcode = response.error.code;
      const errdesc = response.error.description;

      log('   parsed:', { status, paymentId, responseURL, errcode,errdesc });

      if (status === 'OK') {
        showMessage('âœ“ Pagamento completato con successo! (OK)', 'success');
        log('âœ“ Pagamento completato con successo! (OK)', 'success');
      } else if (status === 'KO') {
        const errMsg = (err && err.description) ? err.description : 'Pagamento rifiutato (KO)';
        showMessage('âœ— Pagamento fallito: ' + errMsg, 'error');
        log('âœ— Pagamento fallito: ' + errMsg, 'error');
      } else if (status === 'XX') {
        showMessage('â³ Pagamento in attesa di conferma! (XX)', 'pending');
        log('â³ Pagamento in attesa di conferma! (XX)', 'pending');
      } else {
        showMessage('âš  Status inatteso: ' + String(status), 'warning');
        log('âš  Status inatteso: ' + String(status), 'warning');
      }

      if (paymentId) {
        log('Payment ID:', paymentId);
        log('ðŸ’¡ Verifica server-side consigliata con GET /payment/detail');
        // In produzione: verifyPaymentOnServer(paymentId);
      }
    }

    // =====================================================
    // OPEN LIGHTBOX
    // =====================================================
    function openLightbox(shopLogin, paymentID, paymentToken) {
      if (typeof axerve === 'undefined' || !axerve.lightBox || typeof axerve.lightBox.open !== 'function') {
        throw new Error('Libreria Axerve non caricata o incompleta. Controlla lo script axerve.js.');
      }

      log('Apertura Lightbox con:', {
        shopLogin,
        paymentID,
        paymentToken: paymentToken.substring(0, 8) + '...'
      });

      axerve.lightBox.shop = shopLogin;
      lightboxOpen = true;

      if (callbackTimeoutId) clearTimeout(callbackTimeoutId);
      callbackTimeoutId = setTimeout(() => {
        warn(`â° Nessuna callback entro ${CALLBACK_TIMEOUT_MS/1000}s. Possibile redirect/config backoffice.`);
        showMessage(`âš  Nessuna callback entro ${CALLBACK_TIMEOUT_MS/1000}s. Controlla configurazione.`, 'warning');
      }, CALLBACK_TIMEOUT_MS);

      axerve.lightBox.open(paymentID, paymentToken, onAxerveLightboxResult);

      showMessage('âœ“ Lightbox aperto! Completa il pagamento nel popup.', 'success');
    }

    // =====================================================
    // SUBMIT FORM
    // =====================================================
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const shopLogin = document.getElementById('shopLogin').value.trim();
      const paymentID = document.getElementById('paymentID').value.trim();
      const paymentToken = document.getElementById('paymentToken').value.trim();

      const validationErrors = validateInputs(shopLogin, paymentID, paymentToken);
      if (validationErrors.length > 0) {
        showMessage('Errori di validazione: ' + validationErrors.join(', '), 'error');
        warn('Validation errors:', validationErrors);
        return;
      }

      try {
        setLoading(true);
        showMessage('Configurazione Lightbox in corso...', 'info');

        await new Promise(resolve => setTimeout(resolve, 300));

        openLightbox(shopLogin, paymentID, paymentToken);
      } catch (err) {
        error('Errore:', err);
        showMessage('Errore: ' + (err && err.message ? err.message : String(err)), 'error');

        lightboxOpen = false;

        if (callbackTimeoutId) {
          clearTimeout(callbackTimeoutId);
          callbackTimeoutId = null;
        }
      } finally {
        setLoading(false);
      }
    });

    // =====================================================
    // BEFOREUNLOAD
    // =====================================================
    window.addEventListener('beforeunload', (e) => {
      if (lightboxOpen) {
        e.preventDefault();
        e.returnValue = 'Il pagamento Ã¨ in corso. Sei sicuro di voler uscire?';
      }
    });

    // =====================================================
    // LOG INIZIALE
    // =====================================================
    log('===================================');
    log('Fabrick Lightbox - Ready');
    log('Origin pagina:', window.location.origin);
    log('Istruzioni:');
    log('1) Chiama POST /payment/create dal server');
    log('2) Incolla shopLogin, paymentID, paymentToken');
    log('3) Clicca "Apri Lightbox Pagamento"');
    log('===================================');
  </script>
</body>
</html>











